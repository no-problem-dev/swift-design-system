name: Prepare Next Release

# GitHub ReleaseãŒå…¬é–‹ã•ã‚ŒãŸå¾Œã€æ¬¡ã®ãƒªãƒªãƒ¼ã‚¹ã«å‘ã‘ãŸæº–å‚™PRã‚’è‡ªå‹•ä½œæˆ
on:
  release:
    types: [published]
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹

jobs:
  prepare-next-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Delete existing branch if exists
        run: |
          git push origin --delete chore/prepare-next-release 2>/dev/null || true

      - name: Create new branch
        run: |
          git checkout -b chore/prepare-next-release

      - name: Update CHANGELOG.md
        id: update_changelog
        run: |
          # "# å¤‰æ›´å±¥æ­´"ã®å¾Œã«æ–°ã—ã„Unreleasedã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŒ¿å…¥ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã®ã¿ï¼‰
          if ! grep -q "## \[æœªãƒªãƒªãƒ¼ã‚¹\]" CHANGELOG.md; then
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½¿ç”¨ã—ã¦æŒ¿å…¥
            awk '/^# å¤‰æ›´å±¥æ­´$/ {print; print ""; print "## [æœªãƒªãƒªãƒ¼ã‚¹]"; print ""; print "ãªã—"; print ""; next} 1' CHANGELOG.md > CHANGELOG.tmp
            mv CHANGELOG.tmp CHANGELOG.md
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Commit changes
        if: steps.update_changelog.outputs.updated == 'true'
        run: |
          git add CHANGELOG.md
          git commit -m "chore: prepare for next release"

      - name: Push branch
        if: steps.update_changelog.outputs.updated == 'true'
        run: |
          git push origin chore/prepare-next-release

      - name: Output information
        if: steps.update_changelog.outputs.updated == 'true'
        run: |
          echo "âœ… ãƒ–ãƒ©ãƒ³ãƒ 'chore/prepare-next-release' ã‚’ä½œæˆã—ã¾ã—ãŸ"
          echo "ğŸ“ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—: GitHub UIã§ä»¥ä¸‹ã®URLã‹ã‚‰PRã‚’ä½œæˆã—ã¦ãã ã•ã„"
          echo "https://github.com/no-problem-dev/swift-design-system/compare/chore/prepare-next-release?quick_pull=1"
