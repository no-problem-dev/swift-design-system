name: Prepare Next Version

# ãƒªãƒªãƒ¼ã‚¹å…¬é–‹æ™‚ã«æ¬¡ã®ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ç”¨ã®ãƒ–ãƒ©ãƒ³ãƒã¨PRã‚’è‡ªå‹•ä½œæˆ
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      current_version:
        description: 'ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ (ä¾‹: 1.0.3)'
        required: true
        type: string

jobs:
  prepare-next-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Extract version from tag
        id: extract_version
        run: |
          # æ‰‹å‹•å®Ÿè¡Œã®å ´åˆã¯å…¥åŠ›å€¤ã‚’ä½¿ç”¨ã€ãƒªãƒªãƒ¼ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆã®å ´åˆã¯ã‚¿ã‚°ã‹ã‚‰å–å¾—
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            CURRENT_VERSION="${{ github.event.inputs.current_version }}"
          else
            CURRENT_VERSION="${{ github.event.release.tag_name }}"
            CURRENT_VERSION="${CURRENT_VERSION#v}"
          fi
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆä¾‹: 1.0.2 â†’ 1.0.3ï¼‰
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VERSION="$MAJOR.$MINOR.$NEXT_PATCH"
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Next version will be: v$NEXT_VERSION"

      - name: Create branch for next version
        run: |
          BRANCH_NAME="prepare/v${{ steps.extract_version.outputs.next_version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"

      - name: Update CHANGELOG.md
        run: |
          NEXT_VERSION="${{ steps.extract_version.outputs.next_version }}"

          # CHANGELOGã®ã€Œæœªãƒªãƒªãƒ¼ã‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
          # macOS/Linuxä¸¡å¯¾å¿œ
          if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            sed -i '' '/## \[æœªãƒªãƒªãƒ¼ã‚¹\]/,/^## \[/{
              /## \[æœªãƒªãƒªãƒ¼ã‚¹\]/!{
                /^## \[/!d
              }
            }' CHANGELOG.md
            sed -i '' '/## \[æœªãƒªãƒªãƒ¼ã‚¹\]/a\
\
ãªã—
' CHANGELOG.md
          else
            # Linux (GitHub Actions)
            sed -i '/## \[æœªãƒªãƒªãƒ¼ã‚¹\]/,/^## \[/{
              /## \[æœªãƒªãƒªãƒ¼ã‚¹\]/!{
                /^## \[/!d
              }
            }' CHANGELOG.md
            sed -i '/## \[æœªãƒªãƒªãƒ¼ã‚¹\]/a\\n\nãªã—' CHANGELOG.md
          fi

          git add CHANGELOG.md
          git commit -m "chore: prepare for v${NEXT_VERSION} development"

      - name: Push branch
        run: |
          BRANCH_NAME="prepare/v${{ steps.extract_version.outputs.next_version }}"
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NEXT_VERSION="${{ steps.extract_version.outputs.next_version }}"
          CURRENT_VERSION="${{ steps.extract_version.outputs.current_version }}"

          gh pr create \
            --draft \
            --title "chore: prepare for v${NEXT_VERSION} development" \
            --body "$(cat <<EOF
          ## æ¦‚è¦

          v${CURRENT_VERSION} ãƒªãƒªãƒ¼ã‚¹å¾Œã®æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ v${NEXT_VERSION} ã®é–‹ç™ºæº–å‚™PRã§ã™ã€‚

          ## å¤‰æ›´å†…å®¹

          - CHANGELOG.md ã®ã€Œæœªãƒªãƒªãƒ¼ã‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ

          ## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

          1. æ–°æ©Ÿèƒ½ã‚„ãƒã‚°ä¿®æ­£ã®PRã‚’ãƒãƒ¼ã‚¸ã™ã‚‹éš›ã€CHANGELOG.mdã®ã€Œæœªãƒªãƒªãƒ¼ã‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«å¤‰æ›´å†…å®¹ã‚’è¨˜è¼‰
          2. v${NEXT_VERSION}ã®ãƒªãƒªãƒ¼ã‚¹æº–å‚™ãŒæ•´ã£ãŸã‚‰ã€ã“ã®PRã‚’ã€ŒReady for reviewã€ã«å¤‰æ›´
          3. ãƒ¬ãƒ“ãƒ¥ãƒ¼å¾Œã€mainãƒ–ãƒ©ãƒ³ãƒã«ãƒãƒ¼ã‚¸
          4. v${NEXT_VERSION}ã®ãƒªãƒªãƒ¼ã‚¹ã‚’ä½œæˆ

          ## å‚™è€ƒ

          ã“ã®PRã¯ãƒªãƒªãƒ¼ã‚¹å¾Œã«è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
          é–‹ç™ºãŒé€²ã‚€ã«ã¤ã‚Œã¦ã€CHANGELOG.mdã«å¤‰æ›´å†…å®¹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚

          ---

          ğŸ¤– ã“ã®PRã¯ [\`.github/workflows/prepare-next-version.yml\`](.github/workflows/prepare-next-version.yml) ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
          EOF
          )" \
            --base main \
            --head "prepare/v${NEXT_VERSION}"
