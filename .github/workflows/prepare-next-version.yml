name: Prepare Next Version

# ãƒªãƒªãƒ¼ã‚¹å…¬é–‹æ™‚ã«æ¬¡ã®ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ç”¨ã®ãƒ–ãƒ©ãƒ³ãƒã¨PRã‚’è‡ªå‹•ä½œæˆ
on:
  release:
    types: [published]

jobs:
  prepare-next-version:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Extract version from tag
        id: extract_version
        run: |
          # ã‚¿ã‚°ã‹ã‚‰ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’å–å¾—ï¼ˆä¾‹: v1.0.2 â†’ 1.0.2ï¼‰
          CURRENT_VERSION="${{ github.event.release.tag_name }}"
          CURRENT_VERSION="${CURRENT_VERSION#v}"
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # ãƒ‘ãƒƒãƒãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆï¼ˆä¾‹: 1.0.2 â†’ 1.0.3ï¼‰
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VERSION="$MAJOR.$MINOR.$NEXT_PATCH"
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "Next version will be: v$NEXT_VERSION"

      - name: Create branch for next version
        run: |
          BRANCH_NAME="prepare/v${{ steps.extract_version.outputs.next_version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b "$BRANCH_NAME"

      - name: Update CHANGELOG.md
        run: |
          NEXT_VERSION="${{ steps.extract_version.outputs.next_version }}"

          # CHANGELOGã®ã€Œæœªãƒªãƒªãƒ¼ã‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
          sed -i.bak '/## \[æœªãƒªãƒªãƒ¼ã‚¹\]/,/## \[/c\
## [æœªãƒªãƒªãƒ¼ã‚¹]\
\
ãªã—\
\
## [' CHANGELOG.md

          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm -f CHANGELOG.md.bak

          git add CHANGELOG.md
          git commit -m "chore: prepare for v${NEXT_VERSION} development"

      - name: Push branch
        run: |
          BRANCH_NAME="prepare/v${{ steps.extract_version.outputs.next_version }}"
          git push origin "$BRANCH_NAME"

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          NEXT_VERSION="${{ steps.extract_version.outputs.next_version }}"
          CURRENT_VERSION="${{ steps.extract_version.outputs.current_version }}"

          gh pr create \
            --title "chore: prepare for v${NEXT_VERSION} development" \
            --body "$(cat <<EOF
          ## æ¦‚è¦

          v${CURRENT_VERSION} ãƒªãƒªãƒ¼ã‚¹å¾Œã®æ¬¡æœŸãƒãƒ¼ã‚¸ãƒ§ãƒ³ v${NEXT_VERSION} ã®é–‹ç™ºæº–å‚™PRã§ã™ã€‚

          ## å¤‰æ›´å†…å®¹

          - CHANGELOG.md ã®ã€Œæœªãƒªãƒªãƒ¼ã‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ

          ## å‚™è€ƒ

          ã“ã®PRã¯ãƒªãƒªãƒ¼ã‚¹å¾Œã«è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
          æ¬¡ã®é–‹ç™ºã‚µã‚¤ã‚¯ãƒ«ã‚’é–‹å§‹ã™ã‚‹ãŸã‚ã«ã€ã“ã®PRã‚’ãƒãƒ¼ã‚¸ã—ã¦ãã ã•ã„ã€‚

          ---

          ğŸ¤– ã“ã®PRã¯ [\`.github/workflows/prepare-next-version.yml\`](.github/workflows/prepare-next-version.yml) ã«ã‚ˆã‚Šè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚
          EOF
          )" \
            --base main \
            --head "prepare/v${NEXT_VERSION}"
