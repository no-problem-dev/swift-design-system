name: Auto Release on Merge

# ãƒªãƒªãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒï¼ˆrelease/vX.Y.Zï¼‰ãŒmainã«ãƒãƒ¼ã‚¸ã•ã‚ŒãŸã‚‰è‡ªå‹•çš„ã«ãƒªãƒªãƒ¼ã‚¹å‡¦ç†ã‚’å®Ÿè¡Œ
on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  auto-release:
    # PRãŒãƒãƒ¼ã‚¸ã•ã‚Œã€ã‹ã¤ãƒ–ãƒ©ãƒ³ãƒåãŒrelease/vã§å§‹ã¾ã‚‹å ´åˆã®ã¿å®Ÿè¡Œ
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'release/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Configure git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Extract version from branch name
        id: version
        run: |
          # ãƒ–ãƒ©ãƒ³ãƒåã‹ã‚‰ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’æŠ½å‡º (release/v1.0.11 â†’ v1.0.11)
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          VERSION_TAG="${BRANCH_NAME#release/}"
          VERSION="${VERSION_TAG#v}"

          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "version_tag=$VERSION_TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          echo "ğŸ“¦ ãƒªãƒªãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: $BRANCH_NAME"
          echo "ğŸ·ï¸ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¿ã‚°: $VERSION_TAG"
          echo "ğŸ”¢ ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç•ªå·: $VERSION"

      - name: Validate CHANGELOG entry
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          if ! grep -q "## \[$VERSION\]" CHANGELOG.md; then
            echo "âŒ ã‚¨ãƒ©ãƒ¼: CHANGELOG.mdã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ [$VERSION] ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            echo "ãƒªãƒªãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã§CHANGELOG.mdã‚’æ›´æ–°ã—ã¦ãã ã•ã„"
            exit 1
          fi

          echo "âœ… CHANGELOG.mdã« [$VERSION] ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã™"

      - name: Create and push tag
        run: |
          VERSION_TAG="${{ steps.version.outputs.version_tag }}"

          # ã‚¿ã‚°ãŒæ—¢ã«å­˜åœ¨ã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
          if git rev-parse "$VERSION_TAG" >/dev/null 2>&1; then
            echo "âš ï¸ ã‚¿ã‚° $VERSION_TAG ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            exit 0
          fi

          # ã‚¿ã‚°ã‚’ä½œæˆ
          git tag "$VERSION_TAG"

          # ã‚¿ã‚°ã‚’ãƒ—ãƒƒã‚·ãƒ¥
          git push origin "$VERSION_TAG"

          echo "âœ… ã‚¿ã‚° $VERSION_TAG ã‚’ä½œæˆã—ã¦ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"

      - name: Calculate next version
        id: next_version
        run: |
          VERSION="${{ steps.version.outputs.version }}"

          # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’MAJOR.MINOR.PATCHã«åˆ†è§£
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # PATCHã‚’ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆ
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VERSION="$MAJOR.$MINOR.$NEXT_PATCH"
          NEXT_VERSION_TAG="v$NEXT_VERSION"
          NEXT_BRANCH="release/$NEXT_VERSION_TAG"

          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
          echo "next_version_tag=$NEXT_VERSION_TAG" >> $GITHUB_OUTPUT
          echo "next_branch=$NEXT_BRANCH" >> $GITHUB_OUTPUT

          echo "ğŸ“ˆ æ¬¡ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $NEXT_VERSION"
          echo "ğŸŒ¿ æ¬¡ã®ãƒªãƒªãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ: $NEXT_BRANCH"

      - name: Delete old release branch if exists
        run: |
          NEXT_BRANCH="${{ steps.next_version.outputs.next_branch }}"

          # ãƒªãƒ¢ãƒ¼ãƒˆãƒ–ãƒ©ãƒ³ãƒãŒå­˜åœ¨ã™ã‚‹å ´åˆã¯å‰Šé™¤
          if git ls-remote --heads origin "$NEXT_BRANCH" | grep -q "$NEXT_BRANCH"; then
            git push origin --delete "$NEXT_BRANCH"
            echo "ğŸ—‘ï¸ æ—¢å­˜ã®ãƒ–ãƒ©ãƒ³ãƒ $NEXT_BRANCH ã‚’å‰Šé™¤ã—ã¾ã—ãŸ"
          fi

      - name: Create next release branch
        run: |
          NEXT_BRANCH="${{ steps.next_version.outputs.next_branch }}"

          # mainãƒ–ãƒ©ãƒ³ãƒã‹ã‚‰æ–°ã—ã„ãƒªãƒªãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã‚’ä½œæˆ
          git checkout -b "$NEXT_BRANCH"

          echo "âœ… æ¬¡ã®ãƒªãƒªãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ $NEXT_BRANCH ã‚’ä½œæˆã—ã¾ã—ãŸ"

      - name: Update CHANGELOG for next version
        run: |
          NEXT_VERSION="${{ steps.next_version.outputs.next_version }}"

          # ã€Œæœªãƒªãƒªãƒ¼ã‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ãªã„å ´åˆã®ã¿è¿½åŠ 
          if ! grep -q "## \[æœªãƒªãƒªãƒ¼ã‚¹\]" CHANGELOG.md; then
            # æœ€åˆã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å‰ã«æŒ¿å…¥
            awk '
              /^## \[/ && !inserted {
                print "## [æœªãƒªãƒªãƒ¼ã‚¹]"
                print ""
                print "ãªã—"
                print ""
                inserted = 1
              }
              { print }
            ' CHANGELOG.md > CHANGELOG.tmp
            mv CHANGELOG.tmp CHANGELOG.md

            echo "âœ… CHANGELOG.mdã«ã€Œæœªãƒªãƒªãƒ¼ã‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
          else
            echo "â„¹ï¸ CHANGELOG.mdã«æ—¢ã«ã€Œæœªãƒªãƒªãƒ¼ã‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå­˜åœ¨ã—ã¾ã™"
          fi

      - name: Commit and push next release branch
        run: |
          NEXT_BRANCH="${{ steps.next_version.outputs.next_branch }}"
          NEXT_VERSION_TAG="${{ steps.next_version.outputs.next_version_tag }}"

          # å¤‰æ›´ãŒã‚ã‚‹å ´åˆã®ã¿ã‚³ãƒŸãƒƒãƒˆ
          if git diff --quiet CHANGELOG.md; then
            echo "â„¹ï¸ CHANGELOG.mdã«å¤‰æ›´ãŒãªã„ãŸã‚ã€ã‚³ãƒŸãƒƒãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™"
          else
            git add CHANGELOG.md
            git commit -m "chore: prepare for $NEXT_VERSION_TAG release"
            echo "âœ… å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆã—ã¾ã—ãŸ"
          fi

          # ãƒ–ãƒ©ãƒ³ãƒã‚’ãƒ—ãƒƒã‚·ãƒ¥
          git push origin "$NEXT_BRANCH"

          echo "âœ… ãƒ–ãƒ©ãƒ³ãƒ $NEXT_BRANCH ã‚’ãƒ—ãƒƒã‚·ãƒ¥ã—ã¾ã—ãŸ"

      - name: Create draft PR for next release
        run: |
          NEXT_BRANCH="${{ steps.next_version.outputs.next_branch }}"
          NEXT_VERSION_TAG="${{ steps.next_version.outputs.next_version_tag }}"

          gh pr create \
            --draft \
            --title "Release $NEXT_VERSION_TAG" \
            --body "$(cat <<EOF
          # ğŸš€ Release $NEXT_VERSION_TAG

          æ¬¡ã®ãƒªãƒªãƒ¼ã‚¹æº–å‚™ç”¨ã®ãƒ–ãƒ©ãƒ³ãƒã§ã™ã€‚

          ## ğŸ“ é–‹ç™ºãƒ•ãƒ­ãƒ¼

          1. **é–‹ç™º**: ã“ã®ãƒ–ãƒ©ãƒ³ãƒã«æ–°æ©Ÿèƒ½ãƒ»ä¿®æ­£ã‚’ãƒãƒ¼ã‚¸
          2. **CHANGELOGæ›´æ–°**: \`CHANGELOG.md\` ã®ã€Œæœªãƒªãƒªãƒ¼ã‚¹ã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«å¤‰æ›´ã‚’è¨˜éŒ²
          3. **ãƒªãƒªãƒ¼ã‚¹æº–å‚™**: ã™ã¹ã¦ã®å¤‰æ›´ãŒå®Œäº†ã—ãŸã‚‰ã€ã€Œæœªãƒªãƒªãƒ¼ã‚¹ã€ã‚’ã€Œ$NEXT_VERSION_TAGã€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«å¤‰æ›
          4. **ãƒªãƒªãƒ¼ã‚¹å®Ÿè¡Œ**: ã“ã®PRã‚’ãƒãƒ¼ã‚¸

          ## âš™ï¸ è‡ªå‹•åŒ–

          ã“ã®PRã‚’mainã«ãƒãƒ¼ã‚¸ã™ã‚‹ã¨ã€ä»¥ä¸‹ãŒè‡ªå‹•å®Ÿè¡Œã•ã‚Œã¾ã™ï¼š
          - âœ… ã‚¿ã‚° $NEXT_VERSION_TAG ã®è‡ªå‹•ä½œæˆ
          - âœ… GitHub Releaseã®è‡ªå‹•ä½œæˆ
          - âœ… æ¬¡ã®ãƒªãƒªãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã®è‡ªå‹•ä½œæˆ

          ## ğŸ“‹ ãƒªãƒªãƒ¼ã‚¹å‰ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

          - [ ] CHANGELOG.mdã®ã€Œæœªãƒªãƒªãƒ¼ã‚¹ã€ã‚’ã€Œ[$NEXT_VERSION_TAG]ã€ã«å¤‰æ›
          - [ ] æ—¥ä»˜ã‚’è¨˜è¼‰ï¼ˆYYYY-MM-DDå½¢å¼ï¼‰
          - [ ] æ¯”è¼ƒãƒªãƒ³ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ›´æ–°
          - [ ] ã™ã¹ã¦ã®ãƒ†ã‚¹ãƒˆãŒé€šé
          - [ ] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒæœ€æ–°

          ---
          ğŸ¤– ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ
          EOF
          )" \
            --base main \
            --head "$NEXT_BRANCH"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Summary
        run: |
          VERSION_TAG="${{ steps.version.outputs.version_tag }}"
          NEXT_VERSION_TAG="${{ steps.next_version.outputs.next_version_tag }}"
          NEXT_BRANCH="${{ steps.next_version.outputs.next_branch }}"

          echo "## ğŸ‰ ãƒªãƒªãƒ¼ã‚¹å‡¦ç†å®Œäº†"
          echo ""
          echo "### âœ… å®Ÿè¡Œã•ã‚ŒãŸå‡¦ç†"
          echo "- ã‚¿ã‚° $VERSION_TAG ã‚’ä½œæˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥"
          echo "- release.ymlãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒGitHub Releaseã‚’ä½œæˆã—ã¾ã™"
          echo "- æ¬¡ã®ãƒªãƒªãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒ $NEXT_BRANCH ã‚’ä½œæˆ"
          echo "- æ¬¡ã®ãƒªãƒªãƒ¼ã‚¹ç”¨ã®ãƒ‰ãƒ©ãƒ•ãƒˆPRã‚’ä½œæˆ"
          echo ""
          echo "### ğŸ”— ç¢ºèª"
          echo "- ãƒªãƒªãƒ¼ã‚¹: https://github.com/${{ github.repository }}/releases/tag/$VERSION_TAG"
          echo "- æ¬¡ã®PR: https://github.com/${{ github.repository }}/pulls"
