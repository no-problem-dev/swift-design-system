name: Release

# ã‚¿ã‚°ãŒãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸæ™‚ã«è‡ªå‹•çš„ã«GitHub Releaseã‚’ä½œæˆ
on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Extract changelog for this version
        id: changelog
        run: |
          VERSION=${{ steps.version.outputs.version }}
          TAG=${{ steps.version.outputs.tag }}

          # CHANGELOG.mdã‹ã‚‰è©²å½“ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æŠ½å‡º
          if grep -q "## \[$VERSION\]" CHANGELOG.md; then
            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹è¡Œã‚’è¦‹ã¤ã‘ã‚‹
            START_LINE=$(grep -n "## \[$VERSION\]" CHANGELOG.md | cut -d: -f1)
            # æ¬¡ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®é–‹å§‹è¡Œã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆã¾ãŸã¯æœ«å°¾ï¼‰
            NEXT_LINE=$(tail -n +$((START_LINE + 1)) CHANGELOG.md | grep -n "^## \[" | head -1 | cut -d: -f1)

            if [ -n "$NEXT_LINE" ]; then
              # æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒã‚ã‚‹å ´åˆ
              END_LINE=$((START_LINE + NEXT_LINE - 1))
              sed -n "${START_LINE},${END_LINE}p" CHANGELOG.md > changelog_section.md
            else
              # æœ€å¾Œã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®å ´åˆ
              sed -n "${START_LINE},\$p" CHANGELOG.md > changelog_section.md
            fi

            # ãƒãƒ¼ã‚¸ãƒ§ãƒ³è¦‹å‡ºã—ã‚’å‰Šé™¤
            sed -i '1d' changelog_section.md

            # ãƒªãƒ³ã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å‰Šé™¤
            sed -i '/^\[.*\]: http/d' changelog_section.md

            # ç©ºè¡Œã‚’æ•´ç†
            sed -i '/^$/N;/^\n$/D' changelog_section.md

            # ãƒªãƒªãƒ¼ã‚¹ãƒŽãƒ¼ãƒˆã‚’æ•´å½¢ã—ã¦ä½œæˆ
            cat > release_notes.md <<EOF
          # ðŸŽ‰ ${TAG} ãƒªãƒªãƒ¼ã‚¹

          swift-design-system ${TAG} ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸã€‚

          ## ðŸ“ å¤‰æ›´å†…å®¹

          $(cat changelog_section.md)

          ## ðŸ“¦ ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

          \`\`\`swift
          dependencies: [
              .package(url: "https://github.com/no-problem-dev/swift-design-system.git", .upToNextMajor(from: "1.0.0"))
          ]
          \`\`\`

          ## ðŸ”— ãƒªãƒ³ã‚¯
          - [å¤‰æ›´å±¥æ­´](https://github.com/no-problem-dev/swift-design-system/blob/main/CHANGELOG.md)
          - [ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://no-problem-dev.github.io/swift-design-system/documentation/designsystem/)
          EOF

            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âš ï¸ CHANGELOG.mdã«ãƒãƒ¼ã‚¸ãƒ§ãƒ³ $VERSION ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ" > release_notes.md
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ steps.version.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: false
          generate_release_notes: ${{ steps.changelog.outputs.found != 'true' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
